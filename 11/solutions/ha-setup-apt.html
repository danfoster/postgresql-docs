



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="This guide provides instructions on how to set up a highly available PostgreSQL cluster with Patroni on Debian or Ubuntu.">
      
      
        <meta name="author" content="Percona LLC">
      
      
        <link rel="canonical" href="https://docs.percona.com/postgresql/11/solutions/ha-setup-apt.html">
      
      
        <link rel="prev" href="high-availability.html">
      
      
        <link rel="next" href="ha-setup-yum.html">
      
      
      <link rel="icon" href="../_images/percona-favicon.ico">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.25">
    
    
      
        <title>Deploying on Debian or Ubuntu - Percona Distribution for PostgreSQL</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Poppins";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://unicons.iconscout.com/release/v3.0.3/css/line.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
    
      <link rel="stylesheet" href="../css/percona.css">
    
      <link rel="stylesheet" href="../css/extra.css">
    
      <link rel="stylesheet" href="../css/osano.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
              <!-- Google Tag Manager -->
              <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
              new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
              j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
              'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
              })(window,document,'script','dataLayer','GTM-WBVF48V');</script>
              <!-- End Google Tag Manager -->

              <!-- Google Tag Manager (noscript) -->
              <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WBVF48V"
              height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
              <!-- End Google Tag Manager (noscript) -->
              
    
    
               
                 
                 
                 
                 
                 <meta property="og:type" content="website" />
                 <meta property="og:title" content="Percona Distribution for PostgreSQL - Deploying on Debian or Ubuntu" />
                 <meta property="og:image" content="https://docs.percona.com/postgresql/11/_images/postgresql.png">
                 <meta property="og:url" content="https://docs.percona.com/postgresql/">
                </head>
                <body>
                </body>
              </html>
              
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="percona-light" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deploying-postgresql-for-high-availability-with-patroni-on-debian-or-ubuntu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
              <div>This documentation is for the end of life version of Percona Distribution for PostgreSQL 11. <br><strong><a href="https://www.percona.com/blog/postgresql-11-will-soon-reach-end-of-life/">Learn more about PostgreSQL 11 end of life implications</a>.</strong> See the <strong><a href= ../..>current documentation</a></strong>. </div>
             
            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://percona.com/software/documentation" class="md-header__button md-logo" aria-label="Percona Distribution for PostgreSQL" data-md-component="logo">
      
  <img src="../_images/percona-logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis"><a href="https://www.percona.com/software/documentation">
            Percona Product Documentation
          </a></span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Deploying on Debian or Ubuntu
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="percona-light" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/percona/postgresql-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    percona/postgresql-docs
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://docs.percona.com/percona-for-postgresql" title="Percona Distribution for PostgreSQL" class="md-nav__button md-logo" aria-label="Percona Distribution for PostgreSQL" data-md-component="logo">
      
  <img src="../_images/percona-logo.svg" alt="logo">

    </a>
    Percona Distribution for PostgreSQL
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/percona/postgresql-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    percona/postgresql-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Release notes
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Release notes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Release notes index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.22.upd.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.22 Update (2024-01-22)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.22.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.22 (2023-12-13)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.21.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.21 (2023-08-31)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.20.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.20 (2023-06-30)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.19.upd.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.19 Update (2023-05-22)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.19.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.19 (2023-03-31)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.18.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.18 (2022-12-08)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.17.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.17 (2022-09-08)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.16.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.16 (2022-06-07)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.15.upd2.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.15 Second Update (2022-05-05)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.15.upd.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.15 Update (2022-04-14)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.15.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.15 (2022-04-08)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.14.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.14 (2021-12-20)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.13.upd.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.13 Update (2021-12-07)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.13.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.13 (2021-09-09)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.12.upd3.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.12 Third Update (2021-07-15)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.12.upd2.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.12 Second Update (2021-07-01)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.12.upd.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.12 Update (2021-06-10)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.12.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.12 (2021-05-24)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.11.upd3.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.11 Third Update (2021-06-10)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.11.upd2.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.11 Second Update (2021-05-10)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.11.upd.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.11 Update (2021-04-12)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.11.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.11 (2021-03-08)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.10.upd.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.10 Update (2021-06-10)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.10.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.10 (2020-12-15)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.9.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.9 (2020-09-08)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.8.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.8 (2020-06-11)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.7.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.7 (2020-04-09)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.6.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11.6 (2020-01-23)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11 (2019-09-17)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v11-beta.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 11 (Beta) (2019-05-15)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Installation and Upgrade
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Installation and Upgrade
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Install Percona Distribution for PostgreSQL
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Install Percona Distribution for PostgreSQL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../apt.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Via apt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../yum.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Via yum
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../enable-extensions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Enable Percona Distribution for PostgreSQL extensions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../repo-overview.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Repositories overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../docker.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run in Docker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Migrate from PostgreSQL to Percona Distribution for PostgreSQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../minor-upgrade.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Minor Upgrade of Percona Distribution for PostgreSQL
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Extensions
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Extensions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pg-stat-monitor.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pg_stat_monitor
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Solutions
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Solutions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="high-availability.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    High availability
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            High availability
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Deploying on Debian or Ubuntu
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="ha-setup-apt.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Deploying on Debian or Ubuntu
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Considerations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Initial setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Initial setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-hostnames-in-the-etchosts-file" class="md-nav__link">
    <span class="md-ellipsis">
      Set up hostnames in the /etc/hosts file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-the-software" class="md-nav__link">
    <span class="md-ellipsis">
      Install the software
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-etcd-distributed-store" class="md-nav__link">
    <span class="md-ellipsis">
      Configure ETCD distributed store
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configure ETCD distributed store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-node1" class="md-nav__link">
    <span class="md-ellipsis">
      Configure node1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-node2" class="md-nav__link">
    <span class="md-ellipsis">
      Configure node2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-node3" class="md-nav__link">
    <span class="md-ellipsis">
      Configure node3
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-patroni" class="md-nav__link">
    <span class="md-ellipsis">
      Configure Patroni
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-haproxy" class="md-nav__link">
    <span class="md-ellipsis">
      Configure HAProxy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Next steps
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ha-setup-yum.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying on RHEL or CentOS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ha-test.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testing the Patroni PostgreSQL Cluster
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pgbackrest.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pgBackRest setup
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="backup-recovery.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Backup and disaster recovery
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Backup and disaster recovery
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dr-pgbackrest-setup.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying backup and disaster recovery solution in Percona Distribution for PostgreSQL
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Spatial data handling
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Spatial data handling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="postgis.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="postgis-deploy.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deployment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="postgis-testing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Query spatial data
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="postgis-upgrade.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Upgrade spatial database
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ldap.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LDAP authentication
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../telemetry.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Telemetry
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../uninstalling.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Uninstall
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../licensing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Licensing
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../trademark-policy.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Trademark policy
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                    <br>
                    <label class="md-nav__title" for="__drawer">
    <a href="https://learn.percona.com/download-manual-percona-distribution-for-postgresql-15" onclick="_gaq.push(['b._trackEvent', 'Percona Distribution for PostgreSQL 15', 'Download', 'Download Manual Percona Distribution for PostgreSQL 15']);" class="md-nav__link md-nav__link--active" style="font-size: .7rem;">
      Download PDF
    </a>
  </label> 
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Considerations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Initial setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Initial setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-hostnames-in-the-etchosts-file" class="md-nav__link">
    <span class="md-ellipsis">
      Set up hostnames in the /etc/hosts file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-the-software" class="md-nav__link">
    <span class="md-ellipsis">
      Install the software
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-etcd-distributed-store" class="md-nav__link">
    <span class="md-ellipsis">
      Configure ETCD distributed store
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configure ETCD distributed store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-node1" class="md-nav__link">
    <span class="md-ellipsis">
      Configure node1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-node2" class="md-nav__link">
    <span class="md-ellipsis">
      Configure node2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-node3" class="md-nav__link">
    <span class="md-ellipsis">
      Configure node3
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-patroni" class="md-nav__link">
    <span class="md-ellipsis">
      Configure Patroni
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-haproxy" class="md-nav__link">
    <span class="md-ellipsis">
      Configure HAProxy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Next steps
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                

                <!-- Edit and view button -->
                
                  
                  
                  <a
                    href="https://github.com/percona/postgresql-docs/edit/11/docs/solutions/ha-setup-apt.md"
                    title="edit.link.title"
                    class="md-content__button md-icon"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
                  </a>
                  <a
                    href="https://raw.githubusercontent.com/percona/postgresql-docs/11/docs/solutions/ha-setup-apt.md"
                    title="View source of this page"
                    class="md-content__button md-icon"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.15 8.15 0 0 1-1.23-2Z"/></svg>
                  </a>
                

                <!--
                  Hack: check whether the content contains a h1 headline. If it
                  doesn't, the page title (or respectively site name) is used
                  as the main headline.
                -->
                

                <!-- Markdown content -->
                <h1 id="deploying-postgresql-for-high-availability-with-patroni-on-debian-or-ubuntu">Deploying PostgreSQL for high availability with Patroni on Debian or Ubuntu<a class="headerlink" href="#deploying-postgresql-for-high-availability-with-patroni-on-debian-or-ubuntu" title="Permanent link">&para;</a></h1>
<p>This guide provides instructions on how to set up a highly available PostgreSQL cluster with Patroni on Debian or Ubuntu. </p>
<h2 id="considerations">Considerations<a class="headerlink" href="#considerations" title="Permanent link">&para;</a></h2>
<ol>
<li>This is the example deployment suitable to be used for testing purposes in non-production environments. </li>
<li>In this setup ETCD resides on the same hosts as Patroni. In production, consider deploying ETCD cluster on dedicated hosts or at least have separate disks for ETCD and PostgreSQL. This is because ETCD writes every request from the cluster to disk which can be CPU intensive and affects disk performance. See <a href="https://etcd.io/docs/v3.6/op-guide/hardware/">hardware recommendations</a> for details.</li>
<li>
<p>For this setup, we will use the nodes running on Ubuntu 22.04 as the base operating system:</p>
<table>
<thead>
<tr>
<th>Node name</th>
<th>Application</th>
<th>IP address</th>
</tr>
</thead>
<tbody>
<tr>
<td>node1</td>
<td>Patroni, PostgreSQL, ETCD</td>
<td>10.104.0.1</td>
</tr>
<tr>
<td>node2</td>
<td>Patroni, PostgreSQL, ETCD</td>
<td>10.104.0.2</td>
</tr>
<tr>
<td>node3</td>
<td>Patroni, PostgreSQL, ETCD</td>
<td>10.104.0.3</td>
</tr>
<tr>
<td>HAProxy-demo</td>
<td>HAProxy</td>
<td>10.104.0.6</td>
</tr>
</tbody>
</table>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ideally, in a production (or even non-production) setup, the PostgreSQL nodes will be within a private subnet without any public connectivity to the Internet, and the HAProxy will be in a different subnet that allows client traffic coming only from a selected IP range. To keep things simple, we have implemented this architecture in a private environment, and each node can access the other by its internal, private IP. </p>
</div>
<h2 id="initial-setup">Initial setup<a class="headerlink" href="#initial-setup" title="Permanent link">&para;</a></h2>
<h3 id="set-up-hostnames-in-the-etchosts-file">Set up hostnames in the <code>/etc/hosts</code> file<a class="headerlink" href="#set-up-hostnames-in-the-etchosts-file" title="Permanent link">&para;</a></h3>
<p>It&rsquo;s not necessary to have name resolution, but it makes the whole setup more readable and less error prone. Here, instead of configuring a DNS, we use a local name resolution by updating the file <code>/etc/hosts</code>. By resolving their hostnames to their IP addresses, we make the nodes aware of each other&rsquo;s names and allow their seamless communication. </p>
<ol>
<li>
<p>Run the following command on each node. Change the node name to <code>node1</code>, <code>node2</code> and <code>node3</code> respectively:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>hostnamectl<span class="w"> </span>set-hostname<span class="w"> </span>node1
</code></pre></div>
</li>
<li>
<p>Modify the <code>/etc/hosts</code> file of each PostgreSQL node to include the hostnames and IP addresses of the remaining nodes. Add the following at the end of the <code>/etc/hosts</code> file on all nodes:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><input id="__tabbed_1_4" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">node1</label><label for="__tabbed_1_2">node2</label><label for="__tabbed_1_3">node3</label><label for="__tabbed_1_4">HAproxy-demo</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code># Cluster IP and names 
10.104.0.1 node1 
<span class="hll">10.104.0.2 node2 
</span><span class="hll">10.104.0.3 node3
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code># Cluster IP and names 
<span class="hll">10.104.0.1 node1 
</span>10.104.0.2 node2 
<span class="hll">10.104.0.3 node3
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code># Cluster IP and names 
<span class="hll">10.104.0.1 node1 
</span><span class="hll">10.104.0.2 node2 
</span>10.104.0.3 node3
</code></pre></div>
</div>
<div class="tabbed-block">
<p>The HAProxy instance should have the name resolution for all the three nodes in its <code>/etc/hosts</code> file. Add the following lines at the end of the file:    </p>
<div class="highlight"><pre><span></span><code># Cluster IP and names
10.104.0.6 HAProxy-demo
10.104.0.1 node1
<span class="hll">10.104.0.2 node2
</span><span class="hll">10.104.0.3 node3
</span></code></pre></div>
</div>
</div>
</div>
</li>
</ol>
<h3 id="install-the-software">Install the software<a class="headerlink" href="#install-the-software" title="Permanent link">&para;</a></h3>
<p>Run the following commands on node1<code>,</code>node2<code>and</code>node3`:</p>
<ol>
<li>
<p>Install Percona Distribution for PostgreSQL</p>
<ul>
<li>
<p><a href="https://www.percona.com/doc/percona-repo-config/installing.html">Install <code>percona-release</code></a>.</p>
</li>
<li>
<p>Enable the repository:</p>
</li>
</ul>
<p><div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>percona-release<span class="w"> </span>setup<span class="w"> </span>ppg11
</code></pre></div>
* <a href="../apt.html">Install Percona Distribution for PostgreSQL packages</a>.</p>
</li>
<li>
<p>Install some Python and auxiliary packages to help with Patroni and ETCD</p>
<div class="highlight"><pre><span></span><code>{.bash data-prompt=&quot;$&quot;}
$ sudo apt install python3-pip python3-dev binutils
</code></pre></div>
</li>
<li>
<p>Install ETCD, Patroni, pgBackRest packages:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>percona-patroni<span class="w"> </span><span class="se">\</span>
etcd<span class="w"> </span>etcd-server<span class="w"> </span>etcd-client<span class="w"> </span><span class="se">\</span>
percona-pgbackrest
</code></pre></div>
</li>
<li>
<p>Stop and disable all installed services:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span><span class="o">{</span>etcd,patroni,postgresql<span class="o">}</span>
$<span class="w"> </span>systemctl<span class="w"> </span>disable<span class="w"> </span><span class="o">{</span>etcd,patroni,postgresql<span class="o">}</span>
</code></pre></div>
</li>
<li>
<p>Even though Patroni can use an existing Postgres installation, remove the data directory to force it to initialize a new Postgres cluster instance.</p>
</li>
</ol>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/postgresql/11/main
</code></pre></div>
<h2 id="configure-etcd-distributed-store">Configure ETCD distributed store<a class="headerlink" href="#configure-etcd-distributed-store" title="Permanent link">&para;</a></h2>
<p>The distributed configuration store provides a reliable way to store data that needs to be accessed by large scale distributed systems. The most popular implementation of the distributed configuration store is ETCD. ETCD is deployed as a cluster for fault-tolerance and requires an odd number of members (n/2+1) to agree on updates to the cluster state. An ETCD cluster helps establish a consensus among nodes during a failover and manages the configuration for the three PostgreSQL instances.</p>
<p>The <code>etcd</code> cluster is first started in one node and then the subsequent nodes are added to the first node using the <code>add</code>command. The configuration is stored in the <code>/etc/default/etcd</code> file.</p>
<h3 id="configure-node1">Configure <code>node1</code><a class="headerlink" href="#configure-node1" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>Back up the configuration file</p>
<div class="highlight" data-promp="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>mv<span class="w"> </span>/etc/default/etcd<span class="w"> </span>/etc/default/etcd.orig
</code></pre></div>
</li>
<li>
<p>Export environment variables to simplify the config file creation</p>
<ul>
<li>Node name:</li>
</ul>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">NODE_NAME</span><span class="o">=</span><span class="sb">`</span>hostname<span class="w"> </span>-f<span class="sb">`</span>
</code></pre></div>
<ul>
<li>Node IP:</li>
</ul>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">NODE_IP</span><span class="o">=</span><span class="sb">`</span>hostname<span class="w"> </span>-i<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
</code></pre></div>
<ul>
<li>Initial cluster token for the ETCD cluster during bootstrap:</li>
</ul>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">ETCD_TOKEN</span><span class="o">=</span><span class="s1">&#39;PostgreSQL_HA_Cluster_1&#39;</span>
</code></pre></div>
<ul>
<li>ETCD data directory:</li>
</ul>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">ETCD_DATA_DIR</span><span class="o">=</span><span class="s1">&#39;/var/lib/etcd/postgresql&#39;</span>
</code></pre></div>
</li>
<li>
<p>Modify the <code>/etc/default/etcd</code> configuration file as follows:. </p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">ETCD_NAME=</span><span class="si">${</span><span class="nv">NODE_NAME</span><span class="si">}</span>
<span class="s2">ETCD_INITIAL_CLUSTER=&quot;</span><span class="si">${</span><span class="nv">NODE_NAME</span><span class="si">}</span><span class="o">=</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2380<span class="s2">&quot;</span>
<span class="s2">ETCD_INITIAL_CLUSTER_STATE=&quot;</span>new<span class="s2">&quot;</span>
<span class="s2">ETCD_INITIAL_CLUSTER_TOKEN=&quot;</span><span class="si">${</span><span class="nv">ETCD_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2380<span class="s2">&quot;</span>
<span class="s2">ETCD_DATA_DIR=&quot;</span><span class="si">${</span><span class="nv">ETCD_DATA_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">ETCD_LISTEN_PEER_URLS=&quot;</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2380<span class="s2">&quot;</span>
<span class="s2">ETCD_LISTEN_CLIENT_URLS=&quot;</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2379,http://localhost:2379<span class="s2">&quot;</span>
<span class="s2">ETCD_ADVERTISE_CLIENT_URLS=&quot;</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2379<span class="s2">&quot;</span>
<span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/default/etcd
</code></pre></div>
</li>
<li>
<p>Start the <code>etcd</code> service to apply the changes on <code>node1</code>.</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>etcd
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>etcd
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>etcd
</code></pre></div>
</li>
<li>
<p>Check the etcd cluster members on <code>node1</code>:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>etcdctl<span class="w"> </span>member<span class="w"> </span>list
</code></pre></div>
<p>Sample output:</p>
<div class="no-copy highlight"><pre><span></span><code>21d50d7f768f153a: name=default peerURLs=http://10.104.0.1:2380 clientURLs=http://10.104.0.1:2379 isLeader=true
</code></pre></div>
</li>
<li>
<p>Add the <code>node2</code> to the cluster. Run the following command on <code>node1</code>:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>etcdctl<span class="w"> </span>member<span class="w"> </span>add<span class="w"> </span>node2<span class="w"> </span>http://10.104.0.2:2380
</code></pre></div>
<p>The output resembles the following one:</p>
<div class="no-copy highlight"><pre><span></span><code>Added member named node2 with ID 10042578c504d052 to cluster

ETCD_NAME=&quot;node2&quot;
ETCD_INITIAL_CLUSTER=&quot;node2=http://10.104.0.2:2380,node1=http://10.104.0.1:2380&quot;
ETCD_INITIAL_CLUSTER_STATE=&quot;existing&quot;
</code></pre></div>
<h3 id="configure-node2">Configure <code>node2</code><a class="headerlink" href="#configure-node2" title="Permanent link">&para;</a></h3>
</li>
<li>
<p>Back up the configuration file and export environment variables as described in steps 1-2 of the <a href="#configure-node1"><code>node1</code> configuration</a> </p>
</li>
<li>
<p>Edit the <code>/etc/default/etcd</code> configuration file on <code>node2</code>. Use the result of the <code>add</code> command on <code>node1</code> to change the configuration file as follows:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">ETCD_NAME=&quot;</span>node2<span class="s2">&quot;</span>
<span class="s2">ETCD_INITIAL_CLUSTER=&quot;</span><span class="nv">node1</span><span class="o">=</span>http://10.0.100.1:2380,node2<span class="o">=</span>http://10.0.100.2:2380<span class="s2">&quot;</span>
<span class="s2">ETCD_INITIAL_CLUSTER_STATE=&quot;</span>existing<span class="s2">&quot;</span>

<span class="s2">ETCD_INITIAL_CLUSTER_TOKEN=&quot;</span><span class="si">${</span><span class="nv">ETCD_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2380<span class="s2">&quot;</span>
<span class="s2">ETCD_DATA_DIR=&quot;</span><span class="si">${</span><span class="nv">ETCD_DATA_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">ETCD_LISTEN_PEER_URLS=&quot;</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2380<span class="s2">&quot;</span>
<span class="s2">ETCD_LISTEN_CLIENT_URLS=&quot;</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2379,http://localhost:2379<span class="s2">&quot;</span>
<span class="s2">ETCD_ADVERTISE_CLIENT_URLS=&quot;</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2379<span class="s2">&quot;</span>
<span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/default/etcd
</code></pre></div>
</li>
<li>
<p>Start the <code>etcd</code> service to apply the changes on <code>node2</code>:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>etcd
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>etcd
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>etcd
</code></pre></div>
</li>
</ol>
<h3 id="configure-node3">Configure <code>node3</code><a class="headerlink" href="#configure-node3" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>Add <code>node3</code> to the cluster. <strong>Run the following command on <code>node1</code></strong></p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>etcdctl<span class="w"> </span>member<span class="w"> </span>add<span class="w"> </span>node3<span class="w"> </span>http://10.104.0.3:2380
</code></pre></div>
</li>
<li>
<p>On <code>node3</code>, back up the configuration file and export environment variables as described in steps 1-2 of the <a href="#configure-node1"><code>node1</code> configuration</a> </p>
</li>
<li>
<p>Modify the <code>/etc/default/etcd</code> configuration file and add the output of the <code>add</code> command:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">ETCD_NAME=node3</span>
<span class="s2">ETCD_INITIAL_CLUSTER=&quot;</span><span class="nv">node1</span><span class="o">=</span>http://10.104.0.1:2380,node2<span class="o">=</span>http://10.104.0.2:2380,node3<span class="o">=</span>http://10.104.0.3:2380<span class="s2">&quot;</span>
<span class="s2">ETCD_INITIAL_CLUSTER_STATE=&quot;</span>existing<span class="s2">&quot;  </span>
<span class="s2">ETCD_INITIAL_CLUSTER_TOKEN=&quot;</span><span class="si">${</span><span class="nv">ETCD_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2380<span class="s2">&quot;</span>
<span class="s2">ETCD_DATA_DIR=&quot;</span><span class="si">${</span><span class="nv">ETCD_DATA_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">ETCD_LISTEN_PEER_URLS=&quot;</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2380<span class="s2">&quot;</span>
<span class="s2">ETCD_LISTEN_CLIENT_URLS=&quot;</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2379,http://localhost:2379<span class="s2">&quot;</span>
<span class="s2">ETCD_ADVERTISE_CLIENT_URLS=&quot;</span>http://<span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span>:2379<span class="s2">&quot;</span>
<span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/default/etcd
</code></pre></div>
</li>
<li>
<p>Start the <code>etcd</code> service on <code>node3</code>:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>etcd
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>etcd
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>etcd
</code></pre></div>
</li>
<li>
<p>Check the etcd cluster members.</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>etcdctl<span class="w"> </span>member<span class="w"> </span>list
</code></pre></div>
<p>The output resembles the following:</p>
<div class="highlight"><pre><span></span><code>2d346bd3ae7f07c4: name=node2 peerURLs=http://10.104.0.2:2380 clientURLs=http://10.104.0.2:2379 isLeader=false
8bacb519ebdee8db: name=node3 peerURLs=http://10.104.0.3:2380 clientURLs=http://10.104.0.3:2379 isLeader=false
c5f52ea2ade25e1b: name=node1 peerURLs=http://10.104.0.1:2380 clientURLs=http://10.104.0.1:2379 isLeader=true
</code></pre></div>
</li>
</ol>
<h2 id="configure-patroni">Configure Patroni<a class="headerlink" href="#configure-patroni" title="Permanent link">&para;</a></h2>
<p>Run the following commands on all nodes. You can do this in parallel:</p>
<ol>
<li>
<p>Export and create environment variables to simplify the config file creation:</p>
<ul>
<li>Node name:</li>
</ul>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">NODE_NAME</span><span class="o">=</span><span class="sb">`</span>hostname<span class="w"> </span>-f<span class="sb">`</span>
</code></pre></div>
<ul>
<li>Node IP:</li>
</ul>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">NODE_IP</span><span class="o">=</span><span class="sb">`</span>hostname<span class="w"> </span>-i<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
</code></pre></div>
<ul>
<li>Create variables to store the PATH:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">DATA_DIR</span><span class="o">=</span><span class="s2">&quot;/var/lib/postgresql/11/main&quot;</span>
<span class="nv">PG_BIN_DIR</span><span class="o">=</span><span class="s2">&quot;/usr/lib/postgresql/11/bin&quot;</span>
</code></pre></div>
<p><strong>NOTE</strong>: Check the path to the data and bin folders on your operating system and change it for the variables accordingly.</p>
<ul>
<li>Patroni information:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">NAMESPACE</span><span class="o">=</span><span class="s2">&quot;percona_lab&quot;</span>
<span class="nv">SCOPE</span><span class="o">=</span><span class="s2">&quot;cluster_1&quot;</span>
</code></pre></div>
</li>
<li>
<p>Create the <code>/etc/patroni/patroni.yml</code> configuration file. Add the following configuration for <code>node1</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">namespace: </span><span class="si">${</span><span class="nv">NAMESPACE</span><span class="si">}</span>
<span class="s2">scope: </span><span class="si">${</span><span class="nv">SCOPE</span><span class="si">}</span>
<span class="s2">name: </span><span class="si">${</span><span class="nv">NODE_NAME</span><span class="si">}</span>

<span class="s2">restapi:</span>
<span class="s2">    listen: 0.0.0.0:8008</span>
<span class="s2">    connect_address: </span><span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span><span class="s2">:8008</span>

<span class="s2">etcd:</span>
<span class="s2">    host: </span><span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span><span class="s2">:2379</span>

<span class="s2">bootstrap:</span>
<span class="s2">  # this section will be written into Etcd:/&lt;namespace&gt;/&lt;scope&gt;/config after initializing new cluster</span>
<span class="s2">  dcs:</span>
<span class="s2">      ttl: 30</span>
<span class="s2">      loop_wait: 10</span>
<span class="s2">      retry_timeout: 10</span>
<span class="s2">      maximum_lag_on_failover: 1048576</span>
<span class="s2">      slots:</span>
<span class="s2">          percona_cluster_1:</span>
<span class="s2">          type: physical</span>

<span class="s2">      postgresql:</span>
<span class="s2">          use_pg_rewind: true</span>
<span class="s2">          use_slots: true</span>
<span class="s2">          parameters:</span>
<span class="s2">              wal_level: replica</span>
<span class="s2">              hot_standby: &quot;</span>on<span class="s2">&quot;</span>
<span class="s2">              wal_keep_segments: 10</span>
<span class="s2">              max_wal_senders: 5</span>
<span class="s2">              max_replication_slots: 10</span>
<span class="s2">              wal_log_hints: &quot;</span>on<span class="s2">&quot;</span>
<span class="s2">              logging_collector: &#39;on&#39;</span>

<span class="s2">  # some desired options for &#39;initdb&#39;</span>
<span class="s2">  initdb: # Note: It needs to be a list (some options need values, others are switches)</span>
<span class="s2">      - encoding: UTF8</span>
<span class="s2">      - data-checksums</span>

<span class="s2">  pg_hba: # Add following lines to pg_hba.conf after running &#39;initdb&#39;</span>
<span class="s2">      - host replication replicator 127.0.0.1/32 trust</span>
<span class="s2">      - host replication replicator 0.0.0.0/0 md5</span>
<span class="s2">      - host all all 0.0.0.0/0 md5</span>
<span class="s2">      - host all all ::0/0 md5</span>

<span class="s2">  # Some additional users which needs to be created after initializing new cluster</span>
<span class="s2">  users:</span>
<span class="s2">      admin:</span>
<span class="s2">          password: qaz123</span>
<span class="s2">          options:</span>
<span class="s2">              - createrole</span>
<span class="s2">              - createdb</span>
<span class="s2">      percona:</span>
<span class="s2">          password: qaz123</span>
<span class="s2">          options:</span>
<span class="s2">              - createrole</span>
<span class="s2">              - createdb </span>

<span class="s2">postgresql:</span>
<span class="s2">    cluster_name: cluster_1</span>
<span class="s2">    listen: 0.0.0.0:5432</span>
<span class="s2">    connect_address: </span><span class="si">${</span><span class="nv">NODE_IP</span><span class="si">}</span><span class="s2">:5432</span>
<span class="s2">    data_dir: </span><span class="si">${</span><span class="nv">DATADIR</span><span class="si">}</span>
<span class="s2">    bin_dir: </span><span class="si">${</span><span class="nv">PG_BIN_DIR</span><span class="si">}</span>
<span class="s2">    pgpass: /tmp/pgpass</span>
<span class="s2">    authentication:</span>
<span class="s2">        replication:</span>
<span class="s2">            username: replicator</span>
<span class="s2">            password: replPasswd</span>
<span class="s2">        superuser:</span>
<span class="s2">            username: postgres</span>
<span class="s2">            password: qaz123</span>
<span class="s2">    parameters:</span>
<span class="s2">        unix_socket_directories: &quot;</span>/var/run/postgresql/<span class="s2">&quot;</span>
<span class="s2">    create_replica_methods:</span>
<span class="s2">        - basebackup</span>
<span class="s2">    basebackup:</span>
<span class="s2">        checkpoint: &#39;fast&#39;</span>

<span class="s2">tags:</span>
<span class="s2">    nofailover: false</span>
<span class="s2">    noloadbalance: false</span>
<span class="s2">    clonefrom: false</span>
<span class="s2">    nosync: false</span>
<span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/patroni/patroni.yml
</code></pre></div>
<details class="admonition">
<summary>Patroni configuration file</summary>
<p>Let’s take a moment to understand the contents of the <code>patroni.yml</code> file. </p>
<p>The first section provides the details of the node and its connection ports. After that, we have the <code>etcd</code> service and its port details.</p>
<p>Following these, there is a <code>bootstrap</code> section that contains the PostgreSQL configurations and the steps to run once the database is initialized. The <code>pg_hba.conf</code> entries specify all the other nodes that can connect to this node and their authentication mechanism. </p>
</details>
</li>
<li>
<p>Check that the systemd unit file <code>patroni.service</code> is created in <code>/etc/systemd/system</code>. If it is created, skip this step. </p>
</li>
</ol>
<p>If it&rsquo;s <strong>not</strong> created, create it manually and specify the following contents within:</p>
<div class="highlight"><pre><span></span><code>```ini title=&quot;/etc/systemd/system/patroni.service&quot;
[Unit]
Description=Runners to orchestrate a high-availability PostgreSQL
After=syslog.target network.target

[Service]
Type=simple

User=postgres
Group=postgres

# Start the patroni process
ExecStart=/bin/patroni /etc/patroni/patroni.yml

# Send HUP to reload from patroni.yml
ExecReload=/bin/kill -s HUP $MAINPID

# only kill the patroni process, not its children, so it will gracefully stop postgres
KillMode=process

# Give a reasonable amount of time for the server to start up/shut down
TimeoutSec=30

# Do not restart the service if it crashes, we want to manually inspect database on failure
Restart=no

[Install]
WantedBy=multi-user.target
```
</code></pre></div>
<ol>
<li>
<p>Make systemd aware of the new service:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload
</code></pre></div>
</li>
<li>
<p>Now it&rsquo;s time to start Patroni. You need the following commands on all nodes but not in parallel. Start with the <code>node1</code> first, wait for the service to come to live, and then proceed with the other nodes one-by-one, always waiting for them to sync with the primary node:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>patroni
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>patroni
</code></pre></div>
</li>
</ol>
<p>When Patroni starts, it initializes PostgreSQL (because the service is not currently running and the data directory is empty) following the directives in the bootstrap section of the configuration file. </p>
<ol>
<li>
<p>Check the service to see if there are errors:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>journalctl<span class="w"> </span>-fu<span class="w"> </span>patroni
</code></pre></div>
<p>A common error is Patroni complaining about the lack of proper entries in the pg_hba.conf file. If you see such errors, you must manually add or fix the entries in that file and then restart the service.</p>
<p>Changing the patroni.yml file and restarting the service will not have any effect here because the bootstrap section specifies the configuration to apply when PostgreSQL is first started in the node. It will not repeat the process even if the Patroni configuration file is modified and the service is restarted.</p>
</li>
<li>
<p>Check the cluster:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>patronictl<span class="w"> </span>-c<span class="w"> </span>/etc/patroni/patroni.yml<span class="w"> </span>list<span class="w"> </span><span class="nv">$SCOPE</span>
</code></pre></div>
<p>The output on <code>node1</code> resembles the following:</p>
<div class="no-copy highlight"><pre><span></span><code>+ Cluster: cluster_1 --+---------+---------+----+-----------+
| Member | Host        | Role    | State   | TL | Lag in MB |
+--------+-------------+---------+---------+----+-----------+
| node-1 | 10.0.100.1  | Leader  | running |  1 |           |
+--------+-------------+---------+---------+----+-----------+
</code></pre></div>
<p>On the remaining nodes:</p>
<div class="no-copy highlight"><pre><span></span><code>+ Cluster: cluster_1 --+---------+---------+----+-----------+
| Member | Host        | Role    | State   | TL | Lag in MB |
+--------+-------------+---------+---------+----+-----------+
| node-1 | 10.0.100.1  | Leader  | running |  1 |           |
| node-2 | 10.0.100.2  | Replica | running |  1 |         0 |
+--------+-------------+---------+---------+----+-----------+
</code></pre></div>
</li>
</ol>
<p>If Patroni has started properly, you should be able to locally connect to a PostgreSQL node using the following command:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>postgres
</code></pre></div>
<p>The command output is the following:</p>
<div class="highlight"><pre><span></span><code>psql (11.19)
Type &quot;help&quot; for help.

postgres=#
</code></pre></div>
<h2 id="configure-haproxy">Configure HAProxy<a class="headerlink" href="#configure-haproxy" title="Permanent link">&para;</a></h2>
<p>HAproxy is the load balancer and the single point of entry to your PostgreSQL cluster for client applications. A client application accesses the HAPpoxy URL and sends its read/write requests there. Behind-the-scene, HAProxy routes write requests to the primary node and read requests - to the secondaries in a round-robin fashion so that no secondary instance is unnecessarily loaded. To make this happen, provide different ports in the HAProxy configuration file. In this deployment, writes are routed to port 5000 and reads  - to port 5001</p>
<p>This way, a client application doesn’t know what node in the underlying cluster is the current primary. HAProxy sends connections to a healthy node (as long as there is at least one healthy node available) and ensures that client application requests are never rejected. </p>
<ol>
<li>
<p>Install HAProxy on the <code>HAProxy-demo</code> node:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>percona-haproxy
</code></pre></div>
</li>
<li>
<p>The HAProxy configuration file path is: <code>/etc/haproxy/haproxy.cfg</code>. Specify the following configuration in this file.</p>
<div class="highlight"><pre><span></span><code>global
    maxconn 100

defaults
    log global
    mode tcp
    retries 2
    timeout client 30m
    timeout connect 4s
    timeout server 30m
    timeout check 5s

listen stats
    mode http
    bind *:7000
    stats enable
    stats uri /

listen primary
    bind *:5000
    option httpchk /primary 
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server node1 node1:5432 maxconn 100 check port 8008
    server node2 node2:5432 maxconn 100 check port 8008
    server node3 node3:5432 maxconn 100 check port 8008

listen standbys
    balance roundrobin
    bind *:5001
    option httpchk /replica 
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server node1 node1:5432 maxconn 100 check port 8008
    server node2 node2:5432 maxconn 100 check port 8008
    server node3 node3:5432 maxconn 100 check port 8008
</code></pre></div>
<p>HAProxy will use the REST APIs hosted by Patroni to check the health status of each PostgreSQL node and route the requests appropriately. </p>
</li>
<li>
<p>Restart HAProxy:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>haproxy
</code></pre></div>
</li>
<li>
<p>Check the HAProxy logs to see if there are any errors:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>journalctl<span class="w"> </span>-u<span class="w"> </span>haproxy.service<span class="w"> </span>-n<span class="w"> </span><span class="m">100</span><span class="w"> </span>-f
</code></pre></div>
</li>
</ol>
<h2 id="next-steps">Next steps<a class="headerlink" href="#next-steps" title="Permanent link">&para;</a></h2>
<p><a class="md-button" href="pgbackrest.html">Configure pgBackRest</a></p>

                
<div class="md-relbar2__inner md-grid">
<div class="md-content">
  <article class="md-content__inner md-typeset" role="main">    
    <h4>Contact Us </h4>
       <p>For free technical help, visit the Percona <a class="reference external" href="https://forums.percona.com/c/postgresql/25?utm_campaign=Doc%20pages" target="_blank">Community Forum</a>.<br>
        <p>To report bugs or submit feature requests, open a <a class="reference external" href="https://jira.percona.com/projects/DISTPG/issues/" target="_blank">JIRA</a> ticket.<br>
         <p>For paid <a class="reference external" href="https://www.percona.com/services/support"> support </a> and <a class="reference external" href="https://www.percona.com/services/managed-services"> managed </a> or <a class="reference external" href="https://www.percona.com/services/consulting">consulting services </a>, contact <a class="reference external" href="https://www.percona.com/about-percona/contact" target="_blank">Percona Sales</a>.</p>
 </article>
</div>
</div>

                <!-- Last update of source file -->
                
                  
                    






  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">January 26, 2024</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">December 15, 2021</span>
  </span>

    
    
    
  </aside>

                  
                
                <script>
                  !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
                  posthog.init('phc_7unoI9J6Fm0SMrfDp35xNOpCRTkOAibbffQwdGWbHnL',{api_host:'https://eu.posthog.com'})
          </script>
              
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
    <div class="md-copyright__highlight">
 <a href='https://percona.com' target='_blank'>Percona LLC and/or its affiliates, </a> &copy; 2024 — <a href="#" onclick="Osano.cm.showDrawer('osano-cm-dom-info-dialog-open')">Cookie Preferences</a>
    </div>
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["search.highlight", "navigation.top", "navigation.tracking", "content.tabs.link", "content.action.edit", "content.action.view", "content.code.copy"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
<script src="https://cmp.osano.com/Azqe5vTyLOSbN3OuT/49ad85b5-0418-4794-ab81-7599dddd534c/osano.js"></script>

      <script src="../assets/javascripts/bundle.081f42fc.min.js"></script>
      
        <script src="../js/version-select.js"></script>
      
        <script src="../js/promptremover.js"></script>
      
        <script src="../js/consent.js"></script>
      
    

  </body>
</html>